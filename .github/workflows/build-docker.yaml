name: Angular Docker CI/CD without Docker Hub

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Build Angular app
      - name: Build Angular
        run: npm run build -- --configuration production

      # 5️⃣ Build Docker image locally in runner
      - name: Build Docker image
        run: |
          docker build -t angular-app:latest .

      # 6️⃣ Save Docker image to tar file
      - name: Save Docker image
        run: |
          docker save angular-app:latest -o angular-app.tar

      # 7️⃣ Copy Docker image to VM using SSH
      - name: Copy Docker image to VM
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "angular-app.tar"
          target: "~/angular-app.tar"

      # 8️⃣ Load Docker image and restart container on VM
      - name: Deploy Docker container on VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            # Load image
            docker load -i ~/angular-app.tar
            # Stop old container (if exists)
            docker stop angular-app || true
            docker rm angular-app || true
            # Run new container
            docker run -d --name angular-app -p 80:80 angular-app:latest
