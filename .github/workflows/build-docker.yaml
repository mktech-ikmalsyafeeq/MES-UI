name: SSH to Server Only

on:
  workflow_dispatch:   # manual trigger (recommended for testing)

jobs:
  ssh:
    runs-on: ubuntu-latest

    steps:
    - name: Install cloudflared
      run: |
        wget -q -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519

    - name: SSH into server
      env:
        CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
        CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      run: |
        ssh -i ~/.ssh/id_ed25519 \
          -o "ProxyCommand=./cloudflared access ssh \
          --hostname ssh.mktechsb.com \
          --service-token-id $CF_ACCESS_CLIENT_ID \
          --service-token-secret $CF_ACCESS_CLIENT_SECRET" \
          dev@ssh.mktechsb.com << 'EOF'
          
          echo "âœ… SSH connection successful"
          hostname
          whoami
          
        EOF
