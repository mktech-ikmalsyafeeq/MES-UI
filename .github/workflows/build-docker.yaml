name: CI/CD MES-UI Docker Deployment

on:
  push:
    branches:
      - main  # Trigger on pushes to main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code (optional, only needed if you want local artifacts, otherwise can skip)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ SSH into the server and deploy
      - name: Deploy to Ubuntu VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script: |
            echo "Deploying MES-UI on $(hostname)"
            cd ~/MES-UI || exit 1
            echo "Pulling latest code..."
            git reset --hard
            git clean -fd
            git pull origin main
            echo "Building Docker image..."
            docker build -t mes-ui .
            echo "Stopping old container if exists..."
            docker stop mes-ui || true
            docker rm mes-ui || true
            echo "Running new container..."
            docker run -d -p 4200:80 --name mes-ui mes-ui
            echo "Deployment completed!"
